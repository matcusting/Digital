<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title id="title">å¿ƒæƒ…å›æŠ¥ç³»ç»Ÿ - è€å¸ˆåå°</title>
  <script>
    const currentUser = JSON.parse(localStorage.getItem("loggedInUser"));
    if (!currentUser || currentUser.role !== "teacher") {
      alert("è¯·å…ˆç™»å½•è€å¸ˆè´¦æˆ·ï¼");
      // *** å…³é”®ä¿®æ”¹ç‚¹ ***
      // ç™»å½•é¡µç°åœ¨æ˜¯ index.html
      window.location.href = "index.html";
    }
  </script>
  <style>
    body {
      font-family: "Microsoft YaHei", sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      
      /* ğŸŒŠ åŠ¨æ€æ¸å˜èƒŒæ™¯ */
      background: linear-gradient(-45deg, #a18cd1, #fbc2eb, #a6c1ee, #96e6a1);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .container {
      max-width: 1000px;
      margin: 40px auto;
      padding: 40px;
      
      /* âœ¨ æ¯›ç»ç’ƒæ•ˆæœ */
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      position: relative;
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      border-bottom: 2px solid #a18cd1;
      padding-bottom: 10px;
    }

    .filter-group {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.7);
    }

    .filter-item {
        flex: 1;
    }

    .filter-item label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
        color: #555;
    }

    .filter-item input, .filter-item select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      background-color: white;
    }

    th, td {
      border: 1px solid #eee;
      padding: 12px;
      text-align: left;
    }

    th {
      background-color: #a18cd1;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tr:hover {
      background-color: #f0f0f0;
    }

    .risk {
        background-color: #ffdddd !important; /* é£é™©æŠ¥å‘Šé†’ç›®é¢œè‰² */
        font-weight: bold;
        color: #e74c3c;
    }

    .risk:hover {
        background-color: #ffcaca !important;
    }

    #logoutBtnTop {
        position: absolute;
        top: 20px;
        right: 20px;
        width: auto;
        padding: 10px 20px;
        background: #a6c1ee;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s;
    }

    #logoutBtnTop:hover {
        background: #96e6a1;
    }

    #exportBtn {
        width: 100%;
        padding: 12px;
        background: #96e6a1;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s;
        margin-top: 20px;
    }

    #exportBtn:hover {
        background: #a6c1ee;
    }

    .lang-switcher {
        position: absolute;
        top: 20px;
        left: 20px;
    }

    .lang-switcher button {
        width: auto;
        padding: 8px 15px;
        margin: 0 5px;
        background-color: #eee;
        color: #333;
        font-size: 14px;
        display: inline-block;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }

    .lang-switcher button.active {
        background-color: #a18cd1;
        color: white;
    }

    .chart-container {
        margin-top: 40px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<button onclick="logout()" id="logoutBtnTop">ç™»å‡º</button>

<script>
    function logout() {
        localStorage.removeItem("loggedInUser");
        // *** å…³é”®ä¿®æ”¹ç‚¹ ***
        // ç™»å½•é¡µç°åœ¨æ˜¯ index.html
        window.location.href = "index.html";
    }
</script>

<div class="lang-switcher">
    <button id="langZh" onclick="setLanguage('zh')">ä¸­æ–‡</button>
    <button id="langEn" onclick="setLanguage('en')">English</button>
</div>

<div class="container">
  <h1 id="headerTitle">å¿ƒæƒ…å›æŠ¥ç³»ç»Ÿ - è€å¸ˆåå°</h1>

  <div class="filter-group">
      <div class="filter-item">
          <label for="filterName" id="filterNameLabel">æŒ‰å§“åè¿‡æ»¤</label>
          <input type="text" id="filterName" placeholder="è¾“å…¥å­¦ç”Ÿå§“å">
      </div>
      <div class="filter-item">
          <label for="filterClass" id="filterClassLabel">æŒ‰ç­çº§/å­¦å·è¿‡æ»¤</label>
          <input type="text" id="filterClass" placeholder="è¾“å…¥ç­çº§æˆ–å­¦å·">
      </div>
      <div class="filter-item">
          <label for="filterMood" id="filterMoodLabel">æŒ‰å¿ƒæƒ…è¿‡æ»¤</label>
          <select id="filterMood">
              <option value="all" id="moodFilterAll">å…¨éƒ¨</option>
              <option value="happy" id="moodFilterHappy">å¿«ä¹ / Happy</option>
              <option value="calm" id="moodFilterCalm">å¹³é™ / Calm</option>
              <option value="bored" id="moodFilterBored">æ— èŠ / Bored</option>
              <option value="stressed" id="moodFilterStressed">å‹åŠ›å¤§ / Stressed</option>
              <option value="sad" id="moodFilterSad">éš¾è¿‡ / Sad</option>
              <option value="angry" id="moodFilterAngry">ç”Ÿæ°” / Angry</option>
              <option value="anxious" id="moodFilterAnxious">ç„¦è™‘ / Anxious</option>
              <option value="hopeless" id="moodFilterHopeless">ç»æœ› / Hopeless</option>
          </select>
      </div>
      <div class="filter-item">
          <label for="filterRisk" id="filterRiskLabel">é£é™©ç­‰çº§</label>
          <select id="filterRisk">
              <option value="all" id="riskFilterAll">å…¨éƒ¨</option>
              <option value="high" id="riskFilterHigh">é«˜é£é™© (æ ‡çº¢)</option>
              <option value="normal" id="riskFilterNormal">æ­£å¸¸</option>
          </select>
      </div>
  </div>

  <table id="reportsTable">
      </table>
  
  <button id="exportBtn" onclick="exportData()" >å¯¼å‡ºæ•°æ®ä¸º Excel/CSV</button>

  <div class="chart-container">
      <h2 id="moodChartTitle" style="text-align: center; color: #333;">å¿ƒæƒ…ç»Ÿè®¡å›¾</h2>
      <canvas id="moodChart"></canvas>
  </div>
</div>

<script>
    const langText = {
        zh: {
            title: "å¿ƒæƒ…å›æŠ¥ç³»ç»Ÿ - è€å¸ˆåå°",
            headerTitle: "å¿ƒæƒ…å›æŠ¥ç³»ç»Ÿ - è€å¸ˆåå°",
            logout: "ç™»å‡º",
            filterNameLabel: "æŒ‰å§“åè¿‡æ»¤",
            filterClassLabel: "æŒ‰ç­çº§/å­¦å·è¿‡æ»¤",
            filterMoodLabel: "æŒ‰å¿ƒæƒ…è¿‡æ»¤",
            filterRiskLabel: "é£é™©ç­‰çº§",
            moodFilterAll: "å…¨éƒ¨", moodFilterHappy: "å¿«ä¹ / Happy", moodFilterCalm: "å¹³é™ / Calm", moodFilterBored: "æ— èŠ / Bored", 
            moodFilterStressed: "å‹åŠ›å¤§ / Stressed", moodFilterSad: "éš¾è¿‡ / Sad", moodFilterAngry: "ç”Ÿæ°” / Angry", moodFilterAnxious: "ç„¦è™‘ / Anxious", moodFilterHopeless: "ç»æœ› / Hopeless",
            riskFilterAll: "å…¨éƒ¨", riskFilterHigh: "é«˜é£é™© (æ ‡çº¢)", riskFilterNormal: "æ­£å¸¸",
            th_date: "æ—¥æœŸ", th_name: "å§“å", th_class: "ç­çº§/å­¦å·", th_mood: "å¿ƒæƒ…", th_problem: "ä¸»è¦é—®é¢˜", th_message: "ç•™è¨€",
            moodChartTitle: "å¿ƒæƒ…ç»Ÿè®¡å›¾",
            exportBtn: "å¯¼å‡ºæ•°æ®ä¸º Excel/CSV",
            placeholderName: "è¾“å…¥å­¦ç”Ÿå§“å",
            placeholderClass: "è¾“å…¥ç­çº§æˆ–å­¦å·",
            noData: "æ²¡æœ‰æŠ¥å‘Šæ•°æ®ã€‚",
            mood_happy: "å¿«ä¹", mood_calm: "å¹³é™", mood_bored: "æ— èŠ", mood_stressed: "å‹åŠ›å¤§", mood_sad: "éš¾è¿‡", mood_angry: "ç”Ÿæ°”", mood_anxious: "ç„¦è™‘", mood_hopeless: "ç»æœ›",
            problem_study: "å­¦ä¹ å‹åŠ›", problem_family: "å®¶åº­å…³ç³»", problem_relationship: "äººé™…å…³ç³»", problem_physical: "èº«ä½“ä¸é€‚", problem_sleep: "ç¡çœ é—®é¢˜", problem_career: "æœªæ¥è§„åˆ’", problem_other: "å…¶ä»–",
            no_message: "ï¼ˆæ— ï¼‰"
        },
        en: {
            title: "Mood Report System - Teacher Backend",
            headerTitle: "Mood Report System - Teacher Backend",
            logout: "Logout",
            filterNameLabel: "Filter by Name",
            filterClassLabel: "Filter by Class/ID",
            filterMoodLabel: "Filter by Mood",
            filterRiskLabel: "Risk Level",
            moodFilterAll: "All", moodFilterHappy: "Happy", moodFilterCalm: "Calm", moodFilterBored: "Bored", 
            moodFilterStressed: "Stressed", moodFilterSad: "Sad", moodFilterAngry: "Angry", moodFilterAnxious: "Anxious", moodFilterHopeless: "Hopeless",
            riskFilterAll: "All", riskFilterHigh: "High Risk (Red)", riskFilterNormal: "Normal",
            th_date: "Date", th_name: "Name", th_class: "Class/ID", th_mood: "Mood", th_problem: "Main Problem", th_message: "Message",
            moodChartTitle: "Mood Statistics Chart",
            exportBtn: "Export Data to Excel/CSV",
            placeholderName: "Enter Student Name",
            placeholderClass: "Enter Class or ID",
            noData: "No report data found.",
            mood_happy: "Happy", mood_calm: "Calm", mood_bored: "Bored", mood_stressed: "Stressed", mood_sad: "Sad", mood_angry: "Angry", mood_anxious: "Anxious", mood_hopeless: "Hopeless",
            problem_study: "Study Pressure", problem_family: "Family", problem_relationship: "Relationship", problem_physical: "Physical", problem_sleep: "Sleep Issues", problem_career: "Career", problem_other: "Other",
            no_message: "N/A"
        }
    };
    
    // è¾…åŠ©å‡½æ•°ï¼šå°†æ ‡å‡†å€¼è½¬ä¸ºå¯¹åº”çš„ä¸­æ–‡Keyï¼ˆç”¨äºåœ¨è€å¸ˆç«¯ç»Ÿä¸€æ˜¾ç¤ºä¸­æ–‡ï¼‰
    function getChineseKey(standardValue) {
        const prefix = standardValue.startsWith('mood') ? 'mood_' : standardValue.startsWith('problem') ? 'problem_' : '';
        const key = prefix + standardValue;
        
        // å°è¯•ä»ä¸­æ–‡æ–‡æœ¬ä¸­æŸ¥æ‰¾
        if (langText.zh.hasOwnProperty(key)) {
            return langText.zh[key];
        }
        return standardValue; // å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¿”å›åŸå§‹å€¼
    }
    
    // æ¸²æŸ“è¡¨æ ¼
    function renderTable() {
        const lang = localStorage.getItem("lang") || "zh";
        const t = langText[lang];
        const dataMap = langText[lang]; // ç”¨äºè·å–ç¿»è¯‘æ–‡æœ¬

        const filterName = document.getElementById("filterName").value.toLowerCase();
        const filterClass = document.getElementById("filterClass").value.toLowerCase();
        const filterMood = document.getElementById("filterMood").value;
        const filterRisk = document.getElementById("filterRisk").value;
        const allData = JSON.parse(localStorage.getItem("moodReports") || "[]").reverse(); // å€’åºæ˜¾ç¤ºæœ€æ–°æŠ¥å‘Š
        const table = document.getElementById("reportsTable");
        
        // è¿‡æ»¤æ•°æ®
        const filteredData = allData.filter(record => {
            const nameMatch = record.name.toLowerCase().includes(filterName);
            const classMatch = (record.class || '').toLowerCase().includes(filterClass);
            const moodMatch = filterMood === 'all' || record.mood === filterMood;
            
            let riskMatch = true;
            if (filterRisk === 'high') {
                riskMatch = record.isCrisis || (record.sentimentScore && record.sentimentScore <= -2);
            } else if (filterRisk === 'normal') {
                riskMatch = !(record.isCrisis || (record.sentimentScore && record.sentimentScore <= -2));
            }

            return nameMatch && classMatch && moodMatch && riskMatch;
        });

        if (filteredData.length === 0) {
            table.innerHTML = `<caption>${t.noData}</caption>`;
            renderChart([]); // æ²¡æœ‰æ•°æ®æ—¶æ¸…ç©ºå›¾è¡¨
            return;
        }

        // æ„å»ºè¡¨æ ¼ HTML
        let tableHTML = `
            <thead>
                <tr>
                    <th>${t.th_date}</th>
                    <th>${t.th_name}</th>
                    <th>${t.th_class}</th>
                    <th>${t.th_mood}</th>
                    <th>${t.th_problem}</th>
                    <th>${t.th_message}</th>
                </tr>
            </thead>
            <tbody>
        `;

        filteredData.forEach(record => {
            // å°†å­˜å‚¨çš„æ ‡å‡†å€¼ (å¦‚ 'happy', 'study') è½¬æ¢æˆå½“å‰è¯­è¨€çš„æ˜¾ç¤ºæ–‡æœ¬
            const translatedMood = dataMap['mood_' + record.mood] || record.mood;
            const translatedProblem = dataMap['problem_' + record.problem] || record.problem;
            const messageContent = (record.message || "").trim() !== "" ? record.message : dataMap['no_message'];
            
            // é£é™©åˆ¤æ–­ (isCrisis æˆ– sentimentScore <= -2)
            const score = record.sentimentScore || 0;
            const isHighRisk = record.isCrisis || score <= -2;
            const rowClass = isHighRisk ? 'class="risk"' : '';

            tableHTML += `
                <tr ${rowClass}>
                    <td>${record.date}</td>
                    <td>${record.name}</td>
                    <td>${record.class || dataMap['no_message']}</td>
                    <td>${translatedMood}</td>
                    <td>${translatedProblem}</td>
                    <td>${messageContent}</td>
                </tr>
            `;
        });

        tableHTML += `</tbody>`;
        table.innerHTML = tableHTML;
        
        renderChart(filteredData);
    }
    
    let moodChartInstance = null; // ç”¨äºå­˜å‚¨ Chart å®ä¾‹

    // æ¸²æŸ“å›¾è¡¨
    function renderChart(data) {
        const lang = localStorage.getItem("lang") || "zh";
        const t = langText[lang];
        const ctx = document.getElementById('moodChart').getContext('2d');

        if (moodChartInstance) {
            moodChartInstance.destroy(); // é”€æ¯æ—§å›¾è¡¨
        }

        const moodCounts = data.reduce((acc, record) => {
            const moodDisplay = t['mood_' + record.mood] || record.mood;
            acc[moodDisplay] = (acc[moodDisplay] || 0) + 1;
            return acc;
        }, {});
        
        const labels = Object.keys(moodCounts);
        const counts = Object.values(moodCounts);

        moodChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: t.moodChartTitle,
                    data: counts,
                    backgroundColor: [
                        '#96e6a1', // happy
                        '#a6c1ee', // calm
                        '#cccccc', // bored
                        '#ffcc99', // stressed
                        '#a18cd1', // sad
                        '#ff9999', // angry
                        '#fbc2eb', // anxious
                        '#e74c3c'  // hopeless
                    ],
                    borderColor: [
                        '#3cb371', '#6495ed', '#999999', '#ffa500', 
                        '#8a2be2', '#dc143c', '#ff69b4', '#c0392b'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        },
                        title: {
                            display: true,
                            text: t.th_name + ' (' + t.th_mood + ')' // äººæ¬¡
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: t.moodChartTitle
                    }
                }
            }
        });
    }

    // å¯¼å‡ºæ•°æ®
    function exportData() {
        const allData = JSON.parse(localStorage.getItem("moodReports") || "[]").reverse();
        const lang = localStorage.getItem("lang") || "zh";
        const t = langText[lang];
        const dataMap = langText[lang];

        const headers = [t.th_date, t.th_name, t.th_class, t.th_mood, t.th_problem, t.th_message, "æƒ…ç»ªåˆ†æ•°", "æ˜¯å¦å±æœº"];
        let csv = headers.join(',') + '\n';

        allData.forEach(record => {
            const translatedMood = dataMap['mood_' + record.mood] || record.mood;
            const translatedProblem = dataMap['problem_' + record.problem] || record.problem;
            const messageContent = (record.message || "").replace(/"/g, '""'); // å¤„ç†åŒå¼•å·
            
            const row = [
                record.date,
                record.name,
                record.class || '',
                translatedMood,
                translatedProblem,
                `"${messageContent}"`, // ç•™è¨€åŠ åŒå¼•å·ï¼Œé˜²æ­¢é€—å·å¹²æ‰°
                record.sentimentScore || 0,
                record.isCrisis ? 'æ˜¯' : 'å¦'
            ];
            csv += row.join(',') + '\n';
        });

        const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'mood_reports_' + new Date().toLocaleDateString().replace(/\//g, '-') + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }
    
    // è¯­è¨€åˆ‡æ¢å’Œåˆå§‹åŒ–
    function setLanguage(lang) {
        localStorage.setItem("lang", lang);
        const t = langText[lang];

        document.getElementById("langZh").classList.toggle("active", lang === "zh");
        document.getElementById("langEn").classList.toggle("active", lang === "en");

        document.getElementById("title").innerText = t.title;
        document.getElementById("headerTitle").innerText = t.headerTitle;
        document.getElementById("logoutBtnTop").innerText = t.logout;
        
        // è¿‡æ»¤å™¨æ ‡ç­¾å’Œé€‰é¡¹
        document.getElementById("filterNameLabel").innerText = t.filterNameLabel;
        document.getElementById("filterClassLabel").innerText = t.filterClassLabel;
        document.getElementById("filterMoodLabel").innerText = t.filterMoodLabel;
        document.getElementById("filterRiskLabel").innerText = t.filterRiskLabel;
        
        document.getElementById("filterName").placeholder = t.placeholderName;
        document.getElementById("filterClass").placeholder = t.placeholderClass;

        document.getElementById("moodFilterAll").innerText = t.moodFilterAll;
        document.getElementById("moodFilterHappy").innerText = t.moodFilterHappy;
        document.getElementById("moodFilterCalm").innerText = t.moodFilterCalm;
        document.getElementById("moodFilterBored").innerText = t.moodFilterBored;
        document.getElementById("moodFilterStressed").innerText = t.moodFilterStressed;
        document.getElementById("moodFilterSad").innerText = t.moodFilterSad;
        document.getElementById("moodFilterAngry").innerText = t.moodFilterAngry;
        document.getElementById("moodFilterAnxious").innerText = t.moodFilterAnxious;
        document.getElementById("moodFilterHopeless").innerText = t.moodFilterHopeless;

        document.getElementById("riskFilterAll").innerText = t.riskFilterAll;
        document.getElementById("riskFilterHigh").innerText = t.riskFilterHigh;
        document.getElementById("riskFilterNormal").innerText = t.riskFilterNormal;

        document.getElementById("exportBtn").innerText = t.exportBtn;
        document.getElementById("moodChartTitle").innerText = t.moodChartTitle;

        renderTable(); // é‡æ–°æ¸²æŸ“è¡¨æ ¼ä»¥åº”ç”¨æ–°çš„è¯­è¨€
    }

    // äº‹ä»¶ç›‘å¬å™¨
    document.getElementById("filterName").addEventListener("input", renderTable);
    document.getElementById("filterClass").addEventListener("input", renderTable);
    document.getElementById("filterMood").addEventListener("change", renderTable);
    document.getElementById("filterRisk").addEventListener("change", renderTable);
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    const savedLang = localStorage.getItem("lang") || "zh";
    setLanguage(savedLang);
    
</script>

</body>
</html>
