<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å¿ƒæƒ…å›æŠ¥ç³»ç»Ÿ - è€å¸ˆåå°</title>
  <script>
    const currentUser = JSON.parse(localStorage.getItem("loggedInUser"));
    if (!currentUser || currentUser.role !== "teacher") {
      alert("è¯·å…ˆç™»å½•è€å¸ˆè´¦æˆ·ï¼");
      // *** é“¾æ¥ä¿®æ”¹ï¼šä» login.html æ”¹ä¸º index.html ***
      window.location.href = "index.html";
    }
  </script>
  <style>
    body {
      font-family: "Microsoft YaHei", sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      
      /* ğŸŒŠ åŠ¨æ€æ¸å˜èƒŒæ™¯ */
      background: linear-gradient(-45deg, #a18cd1, #fbc2eb, #a6c1ee, #96e6a1);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .container {
      max-width: 1000px;
      margin: 40px auto;
      padding: 40px;
      
      /* âœ¨ æ¯›ç»ç’ƒæ•ˆæœ */
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }

    h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
    
    /* è¡¨æ ¼æ ·å¼ */
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: rgba(255,255,255,0.6); border-radius: 8px; overflow: hidden; }
    th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: center; }
    th { background: #3498db; color: white; }
    
    .lang-switch { text-align: right; margin-bottom: 10px; }
    .lang-switch button { margin-left: 5px; border: none; background: none; font-size: 14px; cursor: pointer; color: #3498db; font-weight: bold; }
    
    /* ç­›é€‰å™¨æ ·å¼ */
    .filter-container { 
        display: flex; flex-wrap: wrap; gap: 15px; padding: 20px; 
        background-color: rgba(255,255,255,0.7); border-radius: 10px; margin-bottom: 20px; 
    }
    .filter-group { display: flex; flex-direction: column; flex-grow: 1; min-width: 200px; }
    .filter-group label { font-size: 13px; font-weight: bold; color: #555; margin-bottom: 5px; }
    .filter-group input, .filter-group select { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
    
    /* æŒ‰é’®æ ·å¼ */
    .action-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .action-buttons button { padding: 10px 20px; font-size: 14px; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; background-color: #2ecc71; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .action-buttons button.print-btn { background-color: #e67e22; }
    .action-buttons button:hover { opacity: 0.9; transform: translateY(-1px); }

    /* ç™»å‡ºæŒ‰é’® */
    #logoutBtnTop {
        position: fixed; top: 15px; right: 15px;
        padding: 8px 15px; background: rgba(255,255,255,0.8); color: #e74c3c;
        border: 1px solid #e74c3c; border-radius: 5px; cursor: pointer; font-weight: bold;
        z-index: 100;
    }
    #logoutBtnTop:hover { background: #e74c3c; color: white; }

    /* Dashboard æ ·å¼ */
    .dashboard-container { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; margin-top: 10px; }
    .stat-card { 
        flex-grow: 1; min-width: 220px; background: rgba(255,255,255,0.9); 
        padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
    }
    .stat-card p { margin: 0 0 10px 0; color: #666; font-weight: bold; font-size: 14px; }
    .stat-card h2 { margin: 0; color: #3498db; font-size: 2.5em; }
    .stat-card h2.stat-alert { color: #e74c3c; }
    .stat-card h2.stat-common { font-size: 1.5em; color: #34495e; }

    /* é«˜é£é™©è¡Œé«˜äº®æ ·å¼ */
    tr.ai-risk-high { background-color: rgba(252, 236, 235, 0.9) !important; } 
    tr.ai-risk-high td { color: #c0392b; font-weight: bold; }
  </style>
</head>
<body>
  <button onclick="logout()" id="logoutBtnTop">ç™»å‡º</button>

  <div class="container">
    <div class="lang-switch">
      ğŸŒ <button onclick="setLanguage('zh')">ä¸­æ–‡</button> | <button onclick="setLanguage('en')">English</button> | <button onclick="setLanguage('ms')">Bahasa</button>
    </div>
    <h1 id="title">ğŸ‘©â€ğŸ« è€å¸ˆåå° - å­¦ç”Ÿå¿ƒæƒ…è®°å½•</h1>

    <h2 id="dashboard_title" style="text-align: left; font-weight: 600; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px;">æ•°æ®æ¦‚è§ˆ</h2>
    <div class="dashboard-container">
        <div class="stat-card"><p id="stat_today_label">ä»Šæ—¥æäº¤</p><h2 id="stat_today_value">0</h2></div>
        <div class="stat-card"><p id="stat_alerts_label">â€œé«˜é£é™©â€æŠ¥å‘Š (å…¨éƒ¨)</p><h2 id="stat_alerts_value" class="stat-alert">0</h2></div>
        <div class="stat-card"><p id="stat_common_label">æœ€å¸¸è§çš„å›°æ‰° (å…¨éƒ¨)</p><h2 id="stat_common_value" class="stat-common">--</h2></div>
    </div>

    <div class="filter-container">
      <div class="filter-group"><label id="label_filter_name">æŒ‰å§“å/å­¦å·æœç´¢ï¼š</label><input type="text" id="filterName" placeholder="è¾“å…¥å§“å..."></div>
      <div class="filter-group"><label id="label_filter_class">æŒ‰ç­çº§æœç´¢ï¼š</label><input type="text" id="filterClass" placeholder="è¾“å…¥ç­çº§..."></div>
      <div class="filter-group"><label id="label_filter_mood">æŒ‰å¿ƒæƒ…ç­›é€‰ï¼š</label><select id="filterMood"></select></div>
    </div>
    
    <div class="action-buttons">
      <button id="exportCsvBtn" onclick="exportToCsv()">å¯¼å‡ºä¸º CSV</button>
      <button id="printBtn" onclick="printReport()" class="print-btn">æ‰“å°æŠ¥å‘Š</button>
    </div>

    <table id="dataTable">
      <thead>
        <tr>
          <th id="th-date">æ—¥æœŸ</th>
          <th id="th-name">å§“å / å­¦å·</th>
          <th id="th-class">ç­çº§</th>
          <th id="th-mood">å¿ƒæƒ…</th>
          <th id="th-problem">ä¸»è¦å›°æ‰°</th>
          <th id="th-message">ç•™è¨€</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // *** é“¾æ¥ä¿®æ”¹ï¼šä» login.html æ”¹ä¸º index.html ***
    function logout() { localStorage.removeItem("loggedInUser"); window.location.href = "index.html"; }

    const translations = {
      zh: {
        title: "ğŸ‘©â€ğŸ« è€å¸ˆåå° - å­¦ç”Ÿå¿ƒæƒ…è®°å½•",
        th_date: "æ—¥æœŸ", th_name: "å§“å / å­¦å·", th_class: "ç­çº§", th_mood: "å¿ƒæƒ…", th_problem: "ä¸»è¦å›°æ‰°", th_message: "ç•™è¨€", 
        logout: "ç™»å‡º",
        no_data: "æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ•°æ®",
        filter_name: "æŒ‰å§“å/å­¦å·æœç´¢ï¼š", filter_name_placeholder: "è¾“å…¥å§“å...",
        filter_class: "æŒ‰ç­çº§æœç´¢ï¼š", filter_class_placeholder: "è¾“å…¥ç­çº§...",
        filter_mood: "æŒ‰å¿ƒæƒ…ç­›é€‰ï¼š", filter_mood_all: "æ˜¾ç¤ºæ‰€æœ‰å¿ƒæƒ…",
        btn_export_csv: "å¯¼å‡ºä¸º CSV", btn_print: "æ‰“å°æŠ¥å‘Š",
        report_title: "å­¦ç”Ÿå¿ƒæƒ…æŠ¥å‘Š (å·²ç­›é€‰)",
        dashboard_title: "æ•°æ®æ¦‚è§ˆ", stat_today: "ä»Šæ—¥æäº¤", stat_alerts: "â€œé«˜é£é™©â€æŠ¥å‘Š (å…¨éƒ¨)", stat_common: "æœ€å¸¸è§çš„å›°æ‰° (å…¨éƒ¨)", stat_none: "æš‚æ— æ•°æ®",
        suffix_times: "æ¬¡",
        data_map: {"ğŸ˜Š å¼€å¿ƒ": "ğŸ˜Š å¼€å¿ƒ", "ğŸ˜ æ™®é€š": "ğŸ˜ æ™®é€š", "ğŸ˜” éš¾è¿‡": "ğŸ˜” éš¾è¿‡", "ğŸ˜¡ ç”Ÿæ°”": "ğŸ˜¡ ç”Ÿæ°”", "ğŸ˜° ç„¦è™‘": "ğŸ˜° ç„¦è™‘", "è¯¾ä¸šå‹åŠ›": "è¯¾ä¸šå‹åŠ›", "äººé™…å…³ç³»": "äººé™…å…³ç³»", "è¢«éœ¸å‡Œ": "è¢«éœ¸å‡Œ", "å®¶åº­é—®é¢˜": "å®¶åº­é—®é¢˜", "å…¶ä»–": "å…¶ä»–", "ï¼ˆæ— ï¼‰": "ï¼ˆæ— ï¼‰"}
      },
      en: {
        title: "ğŸ‘©â€ğŸ« Teacher Dashboard - Student Mood Reports",
        th_date: "Date", th_name: "Name / ID", th_class: "Class", th_mood: "Mood", th_problem: "Main Problem", th_message: "Message",
        logout: "Logout",
        no_data: "No matching data found",
        filter_name: "Search by Name/ID:", filter_name_placeholder: "Enter name...",
        filter_class: "Search by Class:", filter_class_placeholder: "Enter class...",
        filter_mood: "Filter by Mood:", filter_mood_all: "Show All Moods",
        btn_export_csv: "Export to CSV", btn_print: "Print Report",
        report_title: "Student Mood Report (Filtered)",
        dashboard_title: "Data Overview", stat_today: "Submissions Today", stat_alerts: "'High-Risk' Reports (Total)", stat_common: "Most Common Problem (Total)", stat_none: "No Data",
        suffix_times: " times",
        data_map: {"ğŸ˜Š å¼€å¿ƒ": "ğŸ˜Š Happy", "ğŸ˜ æ™®é€š": "ğŸ˜ Okay", "ğŸ˜” éš¾è¿‡": "ğŸ˜” Sad", "ğŸ˜¡ ç”Ÿæ°”": "ğŸ˜¡ Angry", "ğŸ˜° ç„¦è™‘": "ğŸ˜° Anxious", "è¯¾ä¸šå‹åŠ›": "Academic stress", "äººé™…å…³ç³»": "Relationships", "è¢«éœ¸å‡Œ": "Bullying", "å®¶åº­é—®é¢˜": "Family issues", "å…¶ä»–": "Others", "ï¼ˆæ— ï¼‰": "(None)"}
      },
      ms: {
        title: "ğŸ‘©â€ğŸ« Laman Guru - Rekod Emosi Pelajar",
        th_date: "Tarikh", th_name: "Nama / ID", th_class: "Kelas", th_mood: "Perasaan", th_problem: "Masalah Utama", th_message: "Mesej",
        logout: "Log Keluar",
        no_data: "Tiada data yang sepadan",
        filter_name: "Cari ikut Nama/ID:", filter_name_placeholder: "Masukkan nama...",
        filter_class: "Cari ikut Kelas:", filter_class_placeholder: "Masukkan kelas...",
        filter_mood: "Tapis ikut Perasaan:", filter_mood_all: "Tunjuk Semua Perasaan",
        btn_export_csv: "Eksport ke CSV", btn_print: "Cetak Laporan",
        report_title: "Laporan Emosi Pelajar (Ditapis)",
        dashboard_title: "Gambaran Keseluruhan Data", stat_today: "Penyerahan Hari Ini", stat_alerts: "Laporan 'Beresiko Tinggi' (Jumlah)", stat_common: "Masalah Paling Lazim (Jumlah)", stat_none: "Tiada Data",
        suffix_times: " kali",
        data_map: {"ğŸ˜Š å¼€å¿ƒ": "ğŸ˜Š Gembira", "ğŸ˜ æ™®é€š": "ğŸ˜ Biasa", "ğŸ˜” éš¾è¿‡": "ğŸ˜” Sedih", "ğŸ˜¡ ç”Ÿæ°”": "ğŸ˜¡ Marah", "ğŸ˜° ç„¦è™‘": "ğŸ˜° Cemas", "è¯¾ä¸šå‹åŠ›": "Tekanan pelajaran", "äººé™…å…³ç³»": "Hubungan", "è¢«éœ¸å‡Œ": "Buli", "å®¶åº­é—®é¢˜": "Masalah keluarga", "å…¶ä»–": "Lain-lain", "ï¼ˆæ— ï¼‰": "(Tiada)"}
      }
    };

    function getChineseKey(value) {
        if (!value) return value;
        if (translations.zh.data_map[value]) return value;
        const allKeys = Object.keys(translations.zh.data_map);
        for (const key of allKeys) {
            if (translations.en.data_map && translations.en.data_map[key] === value) return key; 
            if (translations.ms.data_map && translations.ms.data_map[key] === value) return key; 
        }
        return value; 
    }

    function setLanguage(lang) {
      localStorage.setItem("lang", lang);
      const t = translations[lang];
      const dataMap = t.data_map || translations.zh.data_map; 

      document.getElementById("logoutBtnTop").innerText = t.logout;

      document.getElementById("title").innerText = t.title;
      document.getElementById("th-date").innerText = t.th_date;
      document.getElementById("th-name").innerText = t.th_name;
      document.getElementById("th-class").innerText = t.th_class; 
      document.getElementById("th-mood").innerText = t.th_mood;
      document.getElementById("th-problem").innerText = t.th_problem;
      document.getElementById("th-message").innerText = t.th_message;

      document.getElementById("label_filter_name").innerText = t.filter_name;
      document.getElementById("filterName").placeholder = t.filter_name_placeholder;
      document.getElementById("label_filter_class").innerText = t.filter_class;
      document.getElementById("filterClass").placeholder = t.filter_class_placeholder;
      document.getElementById("label_filter_mood").innerText = t.filter_mood;

      document.getElementById("exportCsvBtn").innerText = t.btn_export_csv;
      document.getElementById("printBtn").innerText = t.btn_print;

      document.getElementById("dashboard_title").innerText = t.dashboard_title;
      document.getElementById("stat_today_label").innerText = t.stat_today;
      document.getElementById("stat_alerts_label").innerText = t.stat_alerts;
      document.getElementById("stat_common_label").innerText = t.stat_common;

      const moodSelect = document.getElementById("filterMood");
      moodSelect.innerHTML = `<option value="">${t.filter_mood_all}</option>`; 
      const moodKeys = ["ğŸ˜Š å¼€å¿ƒ", "ğŸ˜ æ™®é€š", "ğŸ˜” éš¾è¿‡", "ğŸ˜¡ ç”Ÿæ°”", "ğŸ˜° ç„¦è™‘"];
      moodKeys.forEach(key => {
          const translatedText = dataMap[key] || key;
          moodSelect.innerHTML += `<option value="${key}">${translatedText}</option>`;
      });

      renderDashboard(t, dataMap);
      renderTable();
    }

    function renderDashboard(t, dataMap) {
        const allData = JSON.parse(localStorage.getItem("moodReports") || "[]");
        const todayStr = new Date().toLocaleDateString();
        let totalToday = 0;
        let problemCounts = {};
        let alertMoods = 0;
        const alertKeys = ["ğŸ˜” éš¾è¿‡", "ğŸ˜¡ ç”Ÿæ°”", "ğŸ˜° ç„¦è™‘"];

        allData.forEach(r => {
            if (r.date === todayStr) totalToday++;
            const score = r.sentimentScore || 0;
            const moodKey = getChineseKey(r.mood);
            if (alertKeys.includes(moodKey) || score <= -2) {
                alertMoods++;
            }
            const problemKey = getChineseKey(r.problem);
            if (problemKey) problemCounts[problemKey] = (problemCounts[problemKey] || 0) + 1;
        });

        let mostCommonProblem = t.stat_none;
        if (Object.keys(problemCounts).length > 0) {
            const [key, count] = Object.entries(problemCounts).sort((a, b) => b[1] - a[1])[0];
            const translatedProblem = dataMap[key] || key;
            mostCommonProblem = `${translatedProblem} (${count}${t.suffix_times})`;
        }

        document.getElementById('stat_today_value').innerText = totalToday;
        document.getElementById('stat_alerts_value').innerText = alertMoods;
        document.getElementById('stat_common_value').innerText = mostCommonProblem;
    }

    function getFilteredData() {
        const allData = JSON.parse(localStorage.getItem("moodReports") || "[]");
        const nameFilter = document.getElementById("filterName").value.toLowerCase().trim();
        const classFilter = document.getElementById("filterClass").value.toLowerCase().trim();
        const moodFilter = document.getElementById("filterMood").value; 
        allData.sort((a, b) => new Date(b.date) - new Date(a.date));
        return allData.filter(r => {
            const nameMatch = (r.name || "").toLowerCase().includes(nameFilter);
            const classMatch = (r.class || "").toLowerCase().includes(classFilter);
            const moodMatch = !moodFilter || r.mood === moodFilter;
            return nameMatch && classMatch && moodMatch;
        });
    }

    function renderTable() {
      const lang = localStorage.getItem("lang") || "zh";
      const t = translations[lang];
      const dataMap = t.data_map;
      const filteredData = getFilteredData();
      const tbody = document.querySelector("#dataTable tbody");
      
      tbody.innerHTML = "";

      if (filteredData.length === 0) {
        tbody.innerHTML = `<tr><td colspan='6'>${t.no_data}</td></tr>`; 
      } else {
        filteredData.forEach(r => {
          const chineseMoodKey = getChineseKey(r.mood); 
          const chineseProblemKey = getChineseKey(r.problem); 
          const translatedMood = dataMap[chineseMoodKey] || r.mood; 
          const translatedProblem = dataMap[chineseProblemKey] || r.problem; 
          const messageText = (r.message || "").trim();
          const messageContent = messageText !== "" ? messageText : (dataMap["ï¼ˆæ— ï¼‰"] || "ï¼ˆæ— ï¼‰");

          // AI é«˜äº®é€»è¾‘ (ä¿ç•™)
          const score = r.sentimentScore || 0;
          let rowClass = "";
          if (r.isCrisis || score <= -2) {
              rowClass = "ai-risk-high"; 
          }

          // Google ç¿»è¯‘æŒ‰é’® (ä¿ç•™)
          let translateBtn = "";
          if (messageText !== "") {
              let targetLangCode = "en"; 
              if (lang === "zh") targetLangCode = "zh-CN";
              else if (lang === "ms") targetLangCode = "ms";
              
              const googleTranslateUrl = `https://translate.google.com/?sl=auto&tl=${targetLangCode}&text=${encodeURIComponent(messageText)}&op=translate`;
              translateBtn = `
                  <a href="${googleTranslateUrl}" target="_blank" title="Translate" style="text-decoration:none; margin-left: 8px; cursor:pointer; font-size: 1.2em;">
                      ğŸŒ
                  </a>
              `;
          }

          const row = document.createElement("tr");
          if(rowClass) row.className = rowClass;

          row.innerHTML = `
            <td>${r.date}</td>
            <td>${r.name}</td>
            <td>${r.class || 'N/A'}</td> 
            <td>${translatedMood}</td>
            <td>${translatedProblem}</td>
            <td style="text-align: left; padding-left: 15px;">
                ${messageContent} ${translateBtn}
            </td>
          `;
          tbody.appendChild(row);
        });
      }
    }

    function exportToCsv() {
        const lang = localStorage.getItem("lang") || "zh";
        const t = translations[lang];
        const dataMap = t.data_map;
        const filteredData = getFilteredData();
        const headers = [ t.th_date, t.th_name, t.th_class, t.th_mood, t.th_problem, t.th_message ];
        let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n";
        filteredData.forEach(r => {
            const chineseMoodKey = getChineseKey(r.mood); const chineseProblemKey = getChineseKey(r.problem); 
            const translatedMood = dataMap[chineseMoodKey] || r.mood; const translatedProblem = dataMap[chineseProblemKey] || r.problem; 
            const messageContent = (r.message || "").trim() !== "" ? r.message : (dataMap["ï¼ˆæ— ï¼‰"] || "ï¼ˆæ— ï¼‰");
            const safeMessage = messageContent.includes(",") ? `"${messageContent}"` : messageContent;
            const row = [ r.date, r.name, (r.class || 'N/A'), translatedMood, translatedProblem, safeMessage ];
            csvContent += row.join(",") + "\n";
        });
        const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", "student_mood_report.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    function printReport() {
        const lang = localStorage.getItem("lang") || "zh"; const t = translations[lang]; const dataMap = t.data_map; const filteredData = getFilteredData();
        let htmlContent = `<html><head><title>${t.report_title}</title><style>body{font-family:sans-serif}table{width:100%;border-collapse:collapse}th,td{border:1px solid #000;padding:8px;text-align:left}th{background-color:#f2f2f2}h1{text-align:center}.risk{background-color:#fceceb;color:red}</style></head><body><h1>${t.report_title} (${new Date().toLocaleDateString()})</h1><table><thead><tr><th>${t.th_date}</th><th>${t.th_name}</th><th>${t.th_class}</th><th>${t.th_mood}</th><th>${t.th_problem}</th><th>${t.th_message}</th></tr></thead><tbody>`;
        filteredData.forEach(r => {
            const chineseMoodKey = getChineseKey(r.mood); const chineseProblemKey = getChineseKey(r.problem); const translatedMood = dataMap[chineseMoodKey] || r.mood; const translatedProblem = dataMap[chineseProblemKey] || r.problem; const messageContent = (r.message || "").trim() !== "" ? r.message : (dataMap["ï¼ˆæ— ï¼‰"] || "ï¼ˆæ— ï¼‰");
            const score = r.sentimentScore || 0;
            const rowClass = (r.isCrisis || score <= -2) ? 'class="risk"' : '';
            htmlContent += `<tr ${rowClass}><td>${r.date}</td><td>${r.name}</td><td>${r.class || 'N/A'}</td><td>${translatedMood}</td><td>${translatedProblem}</td><td>${messageContent}</td></tr>`;
        });
        htmlContent += `</tbody></table></body></html>`;
        const printWindow = window.open('', '_blank'); printWindow.document.write(htmlContent); printWindow.document.close(); printWindow.focus(); printWindow.print();
    }

    document.getElementById("filterName").addEventListener("input", renderTable);
    document.getElementById("filterClass").addEventListener("input", renderTable);
    document.getElementById("filterMood").addEventListener("change", renderTable);
    
    const savedLang = localStorage.getItem("lang") || "zh";
    setLanguage(savedLang);
  </script>
</body>
</html>
